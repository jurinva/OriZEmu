//////////////////////////////////////////////////////////////////////////
//                                                                      //
// Orion/Z (Orion-128 + Z80-CARD-II, ORION-Pro) emulator, version 1.05. //
//                                                                      //
//                                                                      //
//             Author: Sergey A.        <a-s-m@km.ru>                   //
//                                                                      //
//             Copyright (C)2006-2016 Sergey A.                         //
//                                                                      //
//   This program is free software; you can redistribute it and/or      //
//                  modify it in any ways.                              //
//   This program is distributed "AS IS" in the hope that it will be    //
//   useful, but WITHOUT ANY WARRANTY; without even the implied         //
//   warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.   //
//                                                                      //
//////////////////////////////////////////////////////////////////////////

Вашему вниманию представляется программа Orion/Z emulator.
Это эмулятор домашнего компьютера Орион-128, описанного в
журнале Радио N1 за 1990г., и модифицированного при помощи 
Z80 Card II (ленинградский вариант установки Z80 в Орион),
а также модификацию Орион-ПРО (Orion-Power).

Программа не требует установки, работает из текущего каталога
куда будет распакована, настройки хранятся в файле, одноименном
исполняемому, но с расширением INI.


Технические характеристики эмулируемого компьютера:

процессор    - Z80 2.5 МГц (режимы турбо: 3.5/5/7/10/20 MГц)
память (ОЗУ) - 512кб       (аналог реальных Орион-Супер4, Орион-ПРО)
клавиатура   - РК86, МС7007 Лениград (совместимо с РК), МС7007 Москва
ROM-BIOS     - страндартный, содержится во внешнем файле
ROM-DISK     - страндартный + расширенный режим (16 страниц по 64к,
               переключаемые битами D0..D3 порта 0FEh), содержится во
               внешнем файле
КНГМД        - эмуляция 1818ВГ93, 2 привода (ODI-файлы)
               порты F700..7003/F710..F713/F720/F714, 10h..14h
               эмулируется режим HD (ODI-диски более 800к)
ЧАСЫ (RTC)   - эмуляция 512ВИ1 на порту F760 (BlackCat inc.)
муз.процессор- эмуляция AY-3-8910 на портах BFFD/FFFD
IDE (HDD)    - эмуляция контролера IDE на 580вв55 (порт F500/F600)
Принтер      - эмуляция 2-х схем принтера CENTRONICS (порт F600)
SD CARD      - Эмулируются 2 варианта:
               = совместимо по схеме с n8vem (port F762):
                 http://n8vem-sbc.pbworks.com/browse/#view=ViewFolder&param=N8VEM%20Schematics
               = совместимо по схеме с MSX MMC-drive V1 (port F762, F763):
                 http://msx.retro8bits.com/sd-mmc-drive.html
               В железе оба варианта не проверялись, только в эмуляторе!
               Эмулируются только SDC карты (non-SDHC, объемом до 1Gb).
последовательный порт (RS-232) - порты F764,F765.
Ethernet-адаптер на чипе RTL8019AS - порты F770..F77F, F780..F7FF

Минимальные требования к PC:

Celeron 400Мгц / 64М RAM / 2M HDD free / Windows 9x, 2000, XP


    При запуске эмулятора можно передать параметры: имена
файлов. Если это файл-снапшот, то он будет загружен; если это 
файл-образ_диска, то он будет установлен как образ диска "A".
Второй параметр командной строки предполагается как образ диска
"B". Также при запуске эмулятора можно передать параметры - имена
файлов *.BRU, *.ORD, *.RKO. Эти файлы обычно содержат ORDOS-код.
Эмулятор загружает их в RAM-диск "В" (ОЗУ второй страницы) так как
они перечислены в командной строке (один за одним пока хватает
места в ОЗУ второй страницы). 
    Можно, к примеру, создать в Windows ассоциации OrionZEm.exe
с файлами "*.ori", "*.odi" и открывать такие файлы прямо из 
Проводника Windows по двойному щелчку. В этом случае все пути в
файле настроек эмулятора (OrionZEm.ini) должны быть полными 
(формат вида "от текущего каталога: .\dir1\dir2\file" всего 
вероятнее не будет работать, т.к. текущий каталог при таком
запуске уже скорее всего не является каталогом эмулятора).
  ВНИМАНИЕ: 
- если OrionZEm.exe запущен с параметрами, то автоматическое
  восстановление автоснапшота из AutoSnap.ori не вызывается,
  т.к. оно перекроет переданные параметры своими.
- при загрузке снапшоты восстаналивают полное состояние эмулятора
  (т.е. включая файловые буфера ОС в памяти Ориона), но они не
  восстанавливают содержимое файлов образов дисков/HDD (это не
  дело эмулятора). Поэтому если между записью снапшота и его 
  восстановлением содержимое файлов образов поменялось, то
  возможны неувязки при записи в эти файлы программами Ориона
  (например, в CP/M)!   Это не ошибка эмулятора!

  На порту F600 кроме эмуляции IDE-контроллера добавлена эмуляция 
произвольных внешних устройств. Модели устройств хранятся в 
подключаемых модулях (плагинах) - специализированных dll, 
подключающихся "на лету" (без дополнительного конфигурирования 
эмулятора - просто копируя dll в каталог эмулятора, что не отменяет 
необходимости конфигурирования самих плагинов - у каждого плагина 
могут быть внутренние настройки - жмите "Configure plugin" на 
закладке "port F600" эмулятора). В настройках эмулятора один из 
плагинов (одно устройство на порт F600) выбирается из списка. 
  В плагине F600prn.dll реализован эмулятор принтера (печать в 
файл или на реальный принтер) для двух наиболее часто 
использовавшихся на Орионе вариантов схем подключения 
принтера с интерфейсом CENTRONICS. Печать тестировалась на 
лазерном принтере под Windows XP. В эмуляторе для тестирования 
применялась АСРМ 1.53 с драйвером LPR.COM А.Грачева 
(Centronix, A0..A7 - data, C7 - strobe, C3 - ready=/busy). 


В составе эмулятора распространяется утилита HddUtil.exe, с помощью
которой под Windows NT, 2000, XP, Vista  можно создать посекторный
образ HDD (как целиком, так и логическго раздела - партиции) в файле
(программа работает аналогично утилите DiskUtil.exe, создающей 
ODI-образы дискет).
Запустите HddUtil.exe без параметров - программа покажет список ключей.

     В общих чертах про ODI-"диски". Первое с чего нужно начать, это
сопоставить виртуальным (эмулируемым программой OrionZEm) дисководам
файлы-образы дискет. Это делается при помощи двух кнопок в панели 
инструментов эмулятора (в верхней части окна): на одной кнопке
написано "А" - тут по нажатию в выпадающем меню можно выбрать файл-образ
для дисковода А (floppy 0) или очистить привод - "извлечь дискету".
Аналогично по кнопке "B" для дисковода В (floppy 1). 
     Ньюанс: поведение Ориона по включению/сбросу зависит от того, 
какой тип Монитора (базовой программы - загрузчика в ПЗУ F800)
использован: некоторые из них загружают с RomDisk-а ORDOS, некоторые
сразу загружают CP/M с дисковода "А". Набор разных Мониторов и небольшое
их описание лежит в подкаталоге .\ROM\ архива эмулятора.
Файл Монитора указывается в настройках эмулятора.
     Незагрузочные диски обычно могут быть 2х вариантов:
  --1. Диски с исполняемыми файлами (программами или играми) под CP/М -
       классическую операционную систему 8-битных ПК, заточенную под
       работу с дисководами. Такие файлы имеют расширение COM (как в
       MS-DOS) и могут запускаться непосредственно из коммандного режима
       CP/M (набрав имя файла) или из графической программы-оболочки
       типа NortonCommander или BridgePanels.
  --2. Диски с программами или играми под ORDOS - оригинальную систему,
       расчитанную на работу с Rom-Disk (ПЗУ) и квазидисками (ОЗУ). 
       Обычно это диски с файловой системой CP/M, содержащие файлы с 
       расширением ORD или BRU. Эти файлы нельзя непосредственно
       запустить из CP/M, их нужно скопировать на "квазидиск", а затем
       уже запускать под ОС ORDOS. Для копирования файлов BRU с дисков
       CP/M на "квазизиск" в ОЗУ можно воспользоваться программой ATLAS,
       расположенной в ROM-Диске эмулятора .\ROM\romdisk1.bin (его нужно
       указать как файл ROM-диска в настройках эмулятора). ATLAS в 
       псевдографическом режиме выбирает с дискеты CP/M файлы *.BRU 
       (*.ORD не понимает - их нужно под CP/M переименовывать в *.BRU)
       и копирует их на квазидиски ORDOS, а уже под ORDOS в командном 
       режиме или оболочке NC с этими файлами можно работать.


     В Версии 1.06 добавлен режим эмуляции последовательного порта (RS-232),
порты F764,F765. Эмулятор осуществляет ввод\вывод в реально существующий в РС
СОМ-порт. Поэтому есть 2 варианта использования этого режима: в настройках 
эмулятора выбрать реальный СОМ-порт и подключить к нему некое устройство, либо
создать в Windows пару виртуальных СОМ-портов на нульмодемном соединении 
(я для этого использую бесплатную утилиту com0com, но есть и платные аналоги),
на одном конце повесить эмулятор (выбрать порт CNCB0), а на другом (CNCA0) -  
эмулятор устройства или программу терминал.


Соответствие некоторых спецкнопок в эмуляторе (RK=PC):
УСТ = Home
ПС = End
СТР = Ins
ЗБ = BackSpace
AP2 = Esc
F1..F5 = F1..F5
Ctrl+G = Del
Ctrl+R = PgUp
Ctrl+C = PgDown
РусLat = F8=F9=Scroll (смотря как настроено в настройках эмулятора на закладке
                       "keyboard")

C учетом "TurboPascal-style"-расширителя (включается в настройках эмулятора на
закладке "keyboard") добавляются PC-комбинации Ctrl+кнопка для курсорных и 
фукциональных кнопок, которые транслируются Ориону в "CTRL-Q-кнопка"-сочетания.
За соответствием (если кому-то нужно, в чем я по правде сказать - сомневаюсь) -
добро пожаловать в исходники (mod8255.pas). 
